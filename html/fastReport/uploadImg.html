<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="../../css/iuapmobile.um.css">
		<link rel="stylesheet" href="../../css/mint.css">
		<link rel="stylesheet" href="../../css/fonts/iconfont.css">

		<script src="../../js/summer.js" ></script>
		<script src="../../js/jquery.min.js" ></script>
		<script src="../../js/font.js" ></script>
		<script src="../../js/vue.js" ></script>
		<script src="../../js/mint.js" ></script>
		<script src="../../js/Frameworks/iuapmobile.frameworks.ui.js" ></script>
		<script src="../../js/common.js" ></script>
		<style>
			.uploadImg{
				font-size: 14px;
				color:#9E9E9E;
			}
			.uploadImg ul{
				overflow:hidden;
				padding:0 .56rem;
			}
			.uploadImg ul li{
				padding:.4rem .4rem 0 .4rem;
				width:50%;
				float:left;
				text-align: center;

				border:1px solid #EFEFEF;
			}
			.uploadImg ul li:nth-child(even){
				padding-right: 0;
			}
			.uploadImg ul li:nth-child(odd){
				padding-left: 0;
			}
			.uploadImg ul li div{
				background: #fff;
			}
			.uploadImg ul li p{margin-top: .2rem;}
			.uploadImg ul li i {
				display: inline-block;
				width:.72rem;
				height:.72rem;
				margin: .94rem 0;
				font-size: 36px;
				position: relative;
				top:-.2rem;
				color:#DEDEDE;
			}
			.uploadImg ul li img{
				width:100%;
				height:2.6rem;
			}
			.mint-popup{
				width:100%;
				padding-top:.2rem;
			}
			.mint-popup p{
				line-height: .88rem;
				text-align: center;
				font-size: 14px;
			}
			.mint-popup p.border{
				border-bottom: 1px solid #EFEFEF;
			}
		</style>
	</head>
	<body>
		<div class="um-win" id="uploadImg" v-cloak>
			<div class="um-content uploadImg">
				<ul>
					<li @click="openPopup('apply')">
						<div><img v-if="applyImg" :src="applyImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>申请人身份证</p>
					</li>
					<li @click="openPopup('marry')">
						<div><img v-if="marryImg"  :src="marryImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>机动车驾驶证</p>
					</li>
					<li @click="openPopup('residence')">
						<div><img v-if="residenceImg"  :src="residenceImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>车辆合格证</p>

					</li>
					<li @click="openPopup('assets')">
						<div><img v-if="assetsImg"  :src="assetsImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>客户面谈记录表</p>
					</li>
					<li @click="openPopup('Interview')">
						<div><img v-if="InterviewImg"  :src="InterviewImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>资信调查报告</p>
					</li>
					<li @click="openPopup('other')">
						<div><img v-if="otherImg"  :src="otherImg" alt="">
						<i v-else class="icon iconfont icon-add"></i></div>
						<p>现场照片</p>
					</li>
				</ul>
      </div>
			<mt-popup v-model="popupVisible" position="bottom">
					<p class='border' @click="openCame">打开相机</p>
					<p class='border' @click="uploadImg">打开相册</p>
					<p @click="claosePopup">取消</p>
			</mt-popup>
    </div>
    <script>
				summerready = function() {
					uploadVue.id=summer.pageParam.id;
					uploadVue.getData();
					var params = ["android.permission.ACCESS_FINE_LOCATION", "android.permission.ACCESS_COARSE_LOCATION", "android.permission.CAMERA", "android.permission.FLASHLIGHT", "android.permission.READ_EXTERNAL_STORAGE", "android.permission.READ_PHONE_STATE", "android.permission.WRITE_EXTERNAL_STORAGE", "android.permission.ACCESS_FINE_LOCATION", "android.permission.ACCESS_COARSE_LOCATION"];
					summer.getPermission(params, function(args) {
						//alert(args); //成功返回OK
					}, function(args) {
						//alert(args); //失败返回illegal access
					})
				}
        var uploadVue=new Vue({
          el:'#uploadImg',
          data(){
            return {
							applyImg:'',
							marryImg:'',
							residenceImg:'',
							assetsImg:'',
							InterviewImg:'',
							otherImg:'',

							popupVisible:false,
							status:'',
							id:'',
							name:'',
							type:'立项',
							customerType:'承租人自然人',
							fileName:''
            }
          },
					mounted(){

					},
					methods:{
						getData(){
							var _this=this;
							ajaxRequest({
								type:'POST',
								url:'appservice/business/getFileByProject',
								param:{
									PROJECT_ID: _this.id
								}
							},function(res){
								console.log(JSON.stringify(res));


							},function(err){
								alert(err);
							})
						},
						openPopup(param){
							this.popupVisible=true
							this.status=param
						},
						claosePopup(){
							this.popupVisible=false
						},
						openCame(){
							// 打开相机
							var that=this
              this.popupVisible=false;
							summer.openCamera({
								compressionRatio:0.5,
								callback : function(args){
									// $summer.alert(args);
								//  alert(args.imgPath);
									if(that.status=='apply'){
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'申请人身份证',
											callback:function(arg){
													that.applyImg=arg.target;
													// $summer.alert(arg.target)
											 }
										});
									}else if(that.status=='marry'){
										// that.marryImg=args.compressImgPath
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'机动车驾驶证',
											callback:function(arg){
													that.marryImg=arg.target;
											 }
										});
									}else if(that.status=='residence'){
										// that.residenceImg=args.compressImgPath
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'车辆合格证',
											callback:function(arg){
													that.residenceImg=arg.target;
											 }
										});
									}else if(that.status=='assets'){
										// that.assetsImg=args.compressImgPath
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'客户面谈记录表',
											callback:function(arg){
													that.assetsImg=arg.target;
											 }
										});
									}else if(that.status=='Interview'){
										// that.InterviewImg=args.compressImgPath
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'资信调查报告',
											callback:function(arg){
													that.InterviewImg=arg.target;
											 }
										});
									}else if(that.status=='other'){
										// that.otherImg=args.compressImgPath
										CommonUtil.watermark({
											srcImage:args.compressImgPath,
											targetImage:args.compressImgPath,
											name:'现场照片',
											callback:function(arg){
													that.otherImg=arg.target;
											 }
										});
									}
								}
							});

						},
						uploadImg(){
							// 选择相册
							this.popupVisible=false
							var that=this
							summer.openPhotoAlbum({
									compressionRatio:0.5,
									type : "multiple",
							    callback : function (args){
							     console.log(JSON.stringify(args))
							      // alert(args.imgPath);
										if(that.status=='apply'){
											that.customerType="承租人自然人"
											that.name="申请人身份证"
										}else if(that.status=='marry'){
											that.customerType="承租人自然人"
											that.name="机动车驾驶证"
										}else if(that.status=='residence'){
											that.customerType="承租人自然人"
											that.name="融资租赁业务客户客户面谈记录表"
										}else if(that.status=='assets'){
											that.customerType="承租人自然人"
											that.name="现场照片"
										}else if(that.status=='Interview'){
											that.customerType="担保人自然人"
											that.name="保证人身份证"
										}else if(that.status=='other'){
											that.customerType="担保人自然人"
											that.name="调查人员及保证人合影照片"

										}

										var length=args.imgPath.length,uploadImgArr=[];
										for(var i=0;i<length;i++){
											compress(args.imgPath[i])
										}
										function compress(i){
											CommonUtil.watermark({
												srcImage:args.imgPath[i],
												targetImage:args.imgPath[i],
												name:that.name,
												callback:function(res){
													console.log("压缩后的"+res)
														uploadImgArr.push({fileURL:res.target,type:"image/jpeg",name:that.name+i});
														if(i=0){that.fileName+=that.name+i}else{that.fileName+="#"+that.name+i}
														if(i<length-1){
															compress(arg.imgPath[i+1])
														}else{
															var dataParams={
																	PROJECT_ID: that.id,
																	TPM_BUSINESS_PLATE:that.type,
																	TPM_CUSTOMER_TYPE:that.customerType,
																	TPM_TYPE:that.name,
																	FILE_NAME:that.fileName
															};
															console.log("上传的参数"+dataParams,"文件数组"+uploadImgArr);
															summer.multiUpload({
																fileArray : uploadImgArr,
																params : dataParams,
																// headers :{"Content-Type" : "application/json"},
																SERVER : "http://122.49.7.88:8080/appservice/business/uploadloadFile",
																timeout : 10
															}, "multiUploadCallback()", "multiUploadErrCallback()");
														}
												 }
											});
										}
									}
							});
						},
						save(){
							//http
							var that=this,imgArr=[];
							if(that.applyImg){imgArr.push({fileURL:that.applyImg,type:"image/jpeg",name:"img1"})}
							if(that.marryImg){imgArr.push({fileURL:that.marryImg,type:"image/jpeg",name:"img2"})}
							if(that.residenceImg){imgArr.push({fileURL:that.residenceImg,type:"image/jpeg",name:"img3"})}
							if(that.assetsImg){imgArr.push({fileURL:that.assetsImg,type:"image/jpeg",name:"img4"})}
							if(that.InterviewImg){imgArr.push({fileURL:that.InterviewImg,type:"image/jpeg",name:"img5"})}
							if(that.otherImg){imgArr.push({fileURL:that.otherImg,type:"image/jpeg",name:"img6"})}
							summer.multiUpload({
						    fileArray : imgArr,
						    params : {
						        PROJECT_ID: that.id  //参数
						    },
						    // headers :{},
						    SERVER : "http://122.49.7.88:8080/appservice/business/uploadloadFile",
						    timeout : 10
							}, "multiUploadCallback()", "multiUploadErrCallback()");


						}
					}
        })
				function save(){
					uploadVue.save()
				}
				function multiUploadCallback(ret){
						alert("成功"+ JSON.stringify(ret));
						// summer.execScript({
						// 		winId: "setProject",
						// 		script: "addRight('uploadImg')"
						// });
						// summer.closeWin()
				}
				function multiUploadErrCallback(err){
						alert("失败"+ JSON.stringify(err));
				}
    </script>
  </body>
</html>
